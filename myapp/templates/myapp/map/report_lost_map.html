{% extends "base.html" %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-geosearch@4.0.0/dist/geosearch.css"/>
    <script src="https://unpkg.com/leaflet-geosearch@4.0.0/dist/geosearch.umd.js"></script>
    <style>
        #lostMapPicker {
            height: 500px; /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏Ç‡∏≠‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà */
            width: 100%;
            border-radius: 12px;
            margin-bottom: 20px;
        }
    </style>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">
    
    <header class="text-center mb-8">
        <h1 class="text-3xl font-extrabold text-red-600">üö® {{ title }}</h1>
        <p class="text-lg text-gray-600 mt-2">‡πÇ‡∏õ‡∏£‡∏î‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡πÉ‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏ô‡∏±‡∏Ç‡∏™‡∏π‡∏ç‡∏´‡∏≤‡∏¢‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢</p>
    </header>

    <div class="bg-white p-6 rounded-xl shadow-2xl border border-gray-100">
        
        <form method="POST" action="{% url 'report_lost_dog' dog.id %}">
            {% csrf_token %}

            <div id="lostMapPicker"></div>

            {{ form.lost_latitude }}
            {{ form.lost_longitude }}

            <div class="form-control mb-4">
                <label class="label"><span class="label-text font-bold">{{ form.lost_location_description.label }}</span></label>
                {{ form.lost_location_description }}
                {% if form.lost_location_description.errors %}<span class="text-error text-sm mt-1">{{ form.lost_location_description.errors }}</span>{% endif %}
            </div>

            <div class="alert shadow-lg mb-6">
                <div>
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-info flex-shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <div>
                        <h3 class="font-bold">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å:</h3>
                        <div class="text-xs">
                            ‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î (Lat): <span id="selected_lat">‡πÇ‡∏õ‡∏£‡∏î‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</span>
                            <span class="mx-2">|</span> 
                            ‡∏•‡∏≠‡∏á‡∏à‡∏¥‡∏à‡∏π‡∏î (Lng): <span id="selected_lng"></span>
                        </div>
                    </div>
                </div>
            </div>

            <button type="submit" class="btn btn-error btn-block btn-lg shadow-lg">
                ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏™‡∏∏‡∏ô‡∏±‡∏Ç‡∏™‡∏π‡∏ç‡∏´‡∏≤‡∏¢
            </button>
            
        </form>
        
    </div>

</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const latInput = document.getElementById('id_lost_latitude');
        const lngInput = document.getElementById('id_lost_longitude');
        const displayLat = document.getElementById('selected_lat');
        const displayLng = document.getElementById('selected_lng');
        let marker = null;
        
        // 1. Initial Map Setup
        // ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏à‡∏≤‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏î‡∏ó‡∏µ‡πà‡∏´‡∏ô‡∏∂‡πà‡∏á (‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏ó‡∏°.)
        const initialLat = parseFloat(latInput.value) || 13.736717;
        const initialLng = parseFloat(lngInput.value) || 100.523186;

        const map = L.map('lostMapPicker').setView([initialLat, initialLng], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // 2. Function to Update Form/Display
        function updateMarker(lat, lng) {
            // A. ‡∏•‡∏ö Marker ‡πÄ‡∏Å‡πà‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
            if (marker) {
                map.removeLayer(marker);
            }
            // B. ‡πÄ‡∏û‡∏¥‡πà‡∏° Marker ‡πÉ‡∏´‡∏°‡πà
            marker = L.marker([lat, lng]).addTo(map);
            
            // C. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡∏•‡∏á‡πÉ‡∏ô Hidden Input
            latInput.value = lat.toFixed(6);
            lngInput.value = lng.toFixed(6);

            // D. ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏´‡πá‡∏ô
            displayLat.textContent = lat.toFixed(6);
            displayLng.textContent = lng.toFixed(6);
            
            // E. ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô Map ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏Å
            map.panTo([lat, lng]);
        }
        
        // 3. Handle Initial Marker (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÄ‡∏Å‡πà‡∏≤‡∏°‡∏≤)
        if (latInput.value && lngInput.value) {
            updateMarker(initialLat, initialLng);
        }

        // 4. Handle Map Click Event (‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î)
        map.on('click', function(e) {
            updateMarker(e.latlng.lat, e.latlng.lng);
        });
        const provider = new GeoSearch.OpenStreetMapProvider();
        const searchControl = new GeoSearch.GeoSearchControl({
            provider: provider,
            style: 'bar',
            showMarker: true,
            showPopup: false,
            autoClose: true,
            retainZoomLevel: false,
            animateZoom: true,
            keepResult: true,
            searchLabel: '‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà...',
        });
        map.addControl(searchControl);
    });


</script>
{% endblock %}