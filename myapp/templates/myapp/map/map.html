{% extends "base.html" %}
{% load static %}

{% block title %}‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏ô‡∏±‡∏Ç‡∏™‡∏π‡∏ç‡∏´‡∏≤‡∏¢{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-geosearch@4.0.0/dist/geosearch.css"/>
    <script src="https://unpkg.com/leaflet-geosearch@4.0.0/dist/geosearch.umd.js"></script>
    <style>
        #lostDogMap {
            height: 700px; /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏Ç‡∏≠‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà */
            width: 100%;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
    </style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
    <h1 class="text-3xl font-bold text-gray-800 mb-6">üìç ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏∏‡∏ô‡∏±‡∏Ç‡∏™‡∏π‡∏ç‡∏´‡∏≤‡∏¢</h1>
    <p class="text-gray-600 mb-6">‡∏£‡∏π‡∏õ‡∏™‡∏∏‡∏ô‡∏±‡∏Ç‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ß‡πà‡∏≤‡∏™‡∏∏‡∏ô‡∏±‡∏Ç‡∏™‡∏π‡∏ç‡∏´‡∏≤‡∏¢</p>
    <div class="flex flex-col md:flex-row gap-6">
        
        <div id="dogListSidebar" class="w-full md:w-1/4 bg-white p-4 rounded-xl shadow-lg border border-gray-100 overflow-y-auto" style="height: 700px;">
            <h2 class="text-xl font-bold mb-4 text-indigo-700">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏∏‡∏ô‡∏±‡∏Ç‡∏ó‡∏µ‡πà‡∏™‡∏π‡∏ç‡∏´‡∏≤‡∏¢ ({{ dogs_count }})</h2>
            
            <div id="dogsListContainer" class="space-y-3">
                <p class="text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠...</p>
            </div>
        </div>

        <div id="lostDogMap" class="w-full md:w-3/4"></div>

    </div>
    <div id="lostDogMap"></div>
</div>

<script>
    // üí° ‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ document.addEventListener ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ DOM ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô
    document.addEventListener('DOMContentLoaded', function() {
        
        // --- 1. Map Initialization (‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ---
        const map = L.map('lostDogMap').setView([13.736717, 100.523186], 10);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // --- 2. Geosearch Initialization (‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà) ---
        const provider = new GeoSearch.OpenStreetMapProvider();
        const searchControl = new GeoSearch.GeoSearchControl({
            provider: provider,
            style: 'bar',
            showMarker: true,
            showPopup: false,
            autoClose: true,
            retainZoomLevel: false,
            animateZoom: true,
            keepResult: true,
            searchLabel: '‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà...',
        });
        map.addControl(searchControl);

        // --- 3. Setup List Variables ---
        // ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Sidebar ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÇ‡∏ï‡πâ‡∏ï‡∏≠‡∏ö
        const dogListContainer = document.getElementById('dogsListContainer');
        const markers = {}; // Dictionary ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πá‡∏ö Marker Objects ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        const allMarkers = []; // Array ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö Marker ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà (fitBounds)
        
        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
        dogListContainer.innerHTML = '<p class="text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>';


        // --- 4. Fetch Data and Render (‡∏£‡∏ß‡∏° logic Marker ‡πÅ‡∏•‡∏∞ List ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô Block ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß) ---
        fetch('{% url "lost_dogs_map_data_api" %}')
            .then(response => {
                if (!response.ok) {
                    // ‡∏î‡∏±‡∏Å‡∏à‡∏±‡∏ö HTTP Error (‡πÄ‡∏ä‡πà‡∏ô 404, 500)
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                const dogs = data.dogs;
                dogListContainer.innerHTML = ''; // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...'

                // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
                if (dogs.length === 0) {
                    dogListContainer.innerHTML = '<p class="text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏ô‡∏±‡∏Ç‡∏™‡∏π‡∏ç‡∏´‡∏≤‡∏¢‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</p>';
                    return; // ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô
                }
                
                dogs.forEach(dog => {
                    
                    // --- 4.1 ‡∏™‡∏£‡πâ‡∏≤‡∏á Custom Icon ---
                    // ‡πÉ‡∏ä‡πâ URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏à‡∏£‡∏¥‡∏á ‡∏´‡∏£‡∏∑‡∏≠ Placeholder (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà path/to/default/dog_image.png)
                    const dogImageUrl = dog.image_url || '{% static "path/to/default/dog_image.png" %}'; 

                    const customIcon = L.divIcon({
                        className: 'lost-dog-marker',
                        html: `
                            <div class="relative flex flex-col items-center">
                                <img src="${dogImageUrl}" class="rounded-full border-4 border-red-500 w-12 h-12 object-cover shadow-lg transform hover:scale-110 transition duration-150" alt="${dog.name}">
                                <div class="mt-1 bg-red-500 text-white text-xs font-semibold px-2 py-0.5 rounded-full shadow-md whitespace-nowrap">${dog.name}</div>
                                <div class="w-0 h-0 border-l-4 border-r-4 border-t-8 border-transparent border-t-red-500 -mt-1 z-10"></div>
                            </div>
                        `,
                        iconSize: [48, 60],
                        iconAnchor: [24, 60]
                    });
                    
                    // --- 4.2 ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏° Marker ---
                    const marker = L.marker([dog.lat, dog.lng], { icon: customIcon }).addTo(map);
                    marker.bindPopup(`
                        <div class="text-center font-bold">üö® ${dog.name} ‡∏™‡∏π‡∏ç‡∏´‡∏≤‡∏¢!</div>
                        <div class="mt-2 text-sm">Lat: ${dog.lat.toFixed(4)}, Lng: ${dog.lng.toFixed(4)}</div>
                        <a href="${dog.detail_url}" class="btn btn-sm btn-block btn-primary mt-2">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</a>
                    `);
                    
                    // ‡πÄ‡∏Å‡πá‡∏ö Marker ‡πÑ‡∏ß‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÇ‡∏ï‡πâ‡∏ï‡∏≠‡∏ö‡πÅ‡∏•‡∏∞ fitBounds
                    markers[dog.id] = marker; 
                    allMarkers.push(marker);


                    // --- 4.3 ‡∏™‡∏£‡πâ‡∏≤‡∏á List Item ‡πÉ‡∏ô Sidebar ---
                    const listItem = document.createElement('div');
                    listItem.className = 'list-item card card-side bg-base-100 shadow-md cursor-pointer hover:bg-gray-100 transition duration-150 border border-gray-200';
                    
                    listItem.innerHTML = `
                        <figure class="w-16 h-16 m-2 rounded-lg overflow-hidden">
                            <img src="${dogImageUrl}" alt="${dog.name}" class="object-cover w-full h-full"/>
                        </figure>
                        <div class="card-body p-3 flex flex-col justify-center">
                            <p class="text-sm font-bold text-red-600">${dog.name}</p>
                            <p class="text-xs text-gray-500">Lat: ${dog.lat.toFixed(4)}, Lng: ${dog.lng.toFixed(4)}</p>
                        </div>
                    `;
                    
                    // --- 4.4 ‡πÄ‡∏û‡∏¥‡πà‡∏° Event Listener (‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å List Item) ---
                    listItem.addEventListener('click', () => {
                        // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏™‡∏∏‡∏ô‡∏±‡∏Ç‡πÅ‡∏•‡∏∞ Zoom ‡πÄ‡∏Ç‡πâ‡∏≤ (FlyTo ‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏ô‡∏∏‡πà‡∏°‡∏ô‡∏ß‡∏•)
                        map.flyTo([dog.lat, dog.lng], 15); 
                        
                        // ‡πÄ‡∏õ‡∏¥‡∏î Popup ‡∏Ç‡∏≠‡∏á Marker ‡∏ô‡∏±‡πâ‡∏ô‡πÜ
                        markers[dog.id].openPopup(); 
                    });

                    dogListContainer.appendChild(listItem);
                });

                // --- 5. ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô Marker ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ---
                if (allMarkers.length > 0) {
                    const markerGroup = new L.featureGroup(allMarkers);
                    map.fitBounds(markerGroup.getBounds().pad(0.5)); 
                }
            })
            .catch(error => {
                console.error('Error fetching lost dog data:', error);
                dogListContainer.innerHTML = '<p class="text-error">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏ô‡∏±‡∏Ç</p>';
                alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏ô‡∏±‡∏Ç‡∏™‡∏π‡∏ç‡∏´‡∏≤‡∏¢‡πÑ‡∏î‡πâ ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Console');
            });
    });
</script>
{% endblock %}