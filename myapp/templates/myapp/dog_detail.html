{% extends "base.html" %}

{% block title %}‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: {{ dog.name }}{% endblock %} 

{% block extra_head %}
<style>
    /* ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á Dropzone ‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö DaisyUI */
    .dropzone {
        border: 2px dashed #3B82F6;
        border-radius: 0.5rem;
        background: #f9fafb;
        min-height: 200px;
        padding: 2rem;
    }
    .dropzone.dz-drag-hover {
        border-color: #2563eb;
        background: #eff6ff;
    }
    .dz-preview {
        margin: 0.5rem;
        display: inline-block;
        position: relative;
    }
    .dz-preview .dz-image {
        border-radius: 0.5rem;
        overflow: hidden;
    }
    .dz-preview .dz-remove {
        position: absolute;
        top: 5px;
        right: 5px;
        background: #ef4444;
        color: white;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 14px;
        z-index: 10;
    }
    .dz-preview .dz-remove:hover {
        background: #dc2626;
    }
    .dz-message {
        text-align: center;
        margin: 2rem 0;
        pointer-events: none;
    }
    .dz-message p {
        margin-bottom: 1rem;
    }
    .dz-message .dz-button {
        background: #3B82F6;
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        border: none;
        cursor: pointer;
        font-weight: 500;
        pointer-events: auto;
    }
    .dz-message .dz-button:hover {
        background: #2563eb;
    }
    /* ‡∏ã‡πà‡∏≠‡∏ô preview ‡∏Ç‡∏≠‡∏á Dropzone ‡πÄ‡∏≠‡∏á ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÉ‡∏ä‡πâ preview ‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤‡πÄ‡∏≠‡∏á */
    .dz-preview {
        display: none !important;
    }
</style>
{% endblock %}

{% block content %}
    <div class="max-w-4xl mx-auto p-8">
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-4xl font-extrabold text-gray-800">{{ dog.name }} <span class="text-xl">üêï</span></h1>
            {% if not is_edit_mode %}
                <div class="flex gap-2">
                    <a href="{% url 'dog_detail' dog.id %}?edit=true" class="btn btn-warning text-white">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l4.125-4.125a1.875 1.875 0 112.652 2.652l-4.125 4.125a4.5 4.5 0 01-1.897 1.13L6 18l-2.685-.8a4.5 4.5 0 01-1.13-1.897l4.125-4.125a1.875 1.875 0 112.652-2.652L16.862 4.487z" />
                        </svg>
                        ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    </a>
                    <button onclick="delete_modal.showModal()" class="btn btn-error text-white">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />
                        </svg>
                        ‡∏•‡∏ö‡∏™‡∏∏‡∏ô‡∏±‡∏Ç
                    </button>
                </div>
            {% endif %}
        </div>
        
        {% if messages %}
            <div class="mb-6">
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} mb-2">
                        <span>{{ message }}</span>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
        
        <div class="mb-6">
            {% if dog.is_lost %}
                <div role="alert" class="alert alert-error text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    <span>‚ö†Ô∏è **‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:** ‡∏™‡∏∏‡∏ô‡∏±‡∏Ç‡∏´‡∏≤‡∏¢ (LOST) ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á!</span>
                </div>
            {% else %}
                <span class="badge badge-lg badge-success text-white font-bold">üè† ‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á</span>
            {% endif %}
        </div>
        
        {% if is_edit_mode %}
            {# ‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç - ‡πÅ‡∏™‡∏î‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏° #}
            <form method="post" enctype="multipart/form-data" id="dog-edit-form" class="space-y-8">
                {% csrf_token %}
                
                <div class="bg-base-100 p-6 rounded-lg border border-gray-200">
                    <h2 class="text-xl font-semibold text-primary-blue-custom mb-4">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="form-control">{{ form.name.label_tag }}{{ form.name }}</div>
                        <div class="form-control">{{ form.breed.label_tag }}{{ form.breed }}</div>
                        <div class="form-control">{{ form.age.label_tag }}{{ form.age }}</div>
                        <div class="form-control">
                            <label class="label">{{ form.gender.label }}</label>
                            {{ form.gender }}
                        </div>
                    </div>
                </div>

                <div class="bg-base-100 p-6 rounded-lg border border-gray-200">
                    <h2 class="text-xl font-semibold text-primary-blue-custom mb-4">‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡∏†‡∏≤‡∏û</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="form-control">{{ form.primary_color.label_tag }}{{ form.primary_color }}</div>
                        <div class="form-control">{{ form.secondary_color.label_tag }}{{ form.secondary_color }}</div>
                        <div class="form-control">
                            <label class="label">{{ form.size.label }}</label>
                            {{ form.size }}
                        </div>
                        <div class="form-control">{{ form.weight.label_tag }}{{ form.weight }}</div>
                        <div class="form-control md:col-span-3">
                            {{ form.distinguishing_marks.label_tag }}
                            {{ form.distinguishing_marks }}
                        </div>
                    </div>
                </div>
                
                <div class="bg-base-100 p-6 rounded-lg border border-gray-200">
                    <h2 class="text-xl font-semibold text-primary-blue-custom mb-4">‡∏ô‡∏¥‡∏™‡∏±‡∏¢‡πÅ‡∏•‡∏∞‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="form-control">{{ form.personality.label_tag }}{{ form.personality }}</div>
                        <div class="form-control">{{ form.favorite_food.label_tag }}{{ form.favorite_food }}</div>
                        <div class="form-control">{{ form.allergies.label_tag }}{{ form.allergies }}</div>
                    </div>
                    <div class="form-control mt-4">
                        <label class="label cursor-pointer justify-start gap-3">
                            {{ form.is_lost }}
                            <span class="label-text text-lg">{{ form.is_lost.label }} (‡∏´‡∏≤‡∏Å‡∏™‡∏∏‡∏ô‡∏±‡∏Ç‡∏´‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß)</span>
                        </label>
                    </div>
                </div>

                <div class="bg-base-100 p-6 rounded-lg border border-gray-200">
                    <h2 class="text-xl font-semibold text-primary-blue-custom mb-4">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏™‡∏∏‡∏ô‡∏±‡∏Ç (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 5 ‡∏£‡∏π‡∏õ)</h2>
                    
                    {# ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà #}
                    {% if dog_images %}
                        <div class="mb-4">
                            <h3 class="text-md font-semibold text-gray-700 mb-2">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:</h3>
                            <div id="existing-images" class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-4">
                                {% for image_form in formset %}
                                    {% if image_form.instance.pk %}
                                        <div class="relative existing-image-item" data-image-id="{{ image_form.instance.pk }}">
                                            <img src="{{ image_form.instance.image.url }}" alt="‡∏£‡∏π‡∏õ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô" class="w-full h-32 object-cover rounded-md border">
                                            <button type="button" class="absolute top-2 right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center hover:bg-red-600 remove-existing-image" data-form-index="{{ forloop.counter0 }}">
                                                √ó
                                            </button>
                                            {% if image_form.DELETE %}
                                                {{ image_form.DELETE }}
                                            {% endif %}
                                            {% if image_form.id %}
                                                {{ image_form.id }}
                                            {% endif %}
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}
                    
                    {# Dropzone Area ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà #}
                    <div id="dropzone-area" class="dropzone">
                        <div class="dz-message">
                            <p class="text-lg text-gray-600 mb-2">‡∏•‡∏≤‡∏Å‡πÅ‡∏•‡∏∞‡∏ß‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå</p>
                        </div>
                    </div>
                    
                    {# Hidden formset ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏´‡∏°‡πà #}
                    <div id="formset-container" style="display: none;">
                        {{ formset.management_form }}
                        <div id="formset-forms"></div>
                    </div>
                    
                    {# Preview area ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà #}
                    <div id="image-preview" class="mt-4 grid grid-cols-2 md:grid-cols-3 gap-4"></div>
                </div>

                <div class="flex gap-2 justify-end">
                    <a href="{% url 'dog_detail' dog.id %}" class="btn btn-outline btn-error">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</a>
                    <button type="submit" class="btn btn-primary text-white">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
                        </svg>
                        ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                    </button>
                </div>
            </form>
        {% else %}
            {# ‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• - ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• #}
            <div class="mb-8">
                <h2 class="text-2xl font-semibold mb-4 text-primary-blue-custom">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</h2>
                <div class="carousel w-full rounded-box shadow-lg">
                    {% for image in dog_images %}
                        <div id="slide{{ forloop.counter }}" class="carousel-item relative w-full h-96">
                            <img src="{{ image.image.url }}" class="w-full object-cover" alt="‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏™‡∏∏‡∏ô‡∏±‡∏Ç {{ dog.name }} #{{ forloop.counter }}" />
                            <div class="absolute flex justify-between transform -translate-y-1/2 left-5 right-5 top-1/2">
                                <a href="#slide{% if forloop.first %}{{ dog_images.count }}{% else %}{{ forloop.counter0 }}{% endif %}" class="btn btn-circle">‚ùÆ</a> 
                                <a href="#slide{% if forloop.last %}1{% else %}{{ forloop.counter|add:1 }}{% endif %}" class="btn btn-circle">‚ùØ</a>
                            </div>
                        </div> 
                    {% empty %}
                        <div class="w-full h-64 bg-gray-200 flex items-center justify-center rounded-box">
                            <span class="text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÑ‡∏ß‡πâ</span>
                        </div>
                    {% endfor %}
                </div>
            </div>
            
            <div class="bg-base-100 p-6 rounded-lg shadow-md space-y-4">
                <h2 class="text-2xl font-semibold border-b pb-2 text-primary-blue-custom">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏ô‡∏±‡∏Ç</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="data-block">
                        <p class="font-bold text-gray-700">‡πÄ‡∏û‡∏®:</p>
                        <p class="text-lg">{{ gender_display|default:"-" }}</p>
                    </div>
                    <div class="data-block">
                        <p class="font-bold text-gray-700">‡∏≠‡∏≤‡∏¢‡∏∏:</p>
                        <p class="text-lg">{{ dog.age|default:"-" }} ‡∏õ‡∏µ</p>
                    </div>
                    <div class="data-block">
                        <p class="font-bold text-gray-700">‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå:</p>
                        <p class="text-lg">{{ dog.breed|default:"-" }}</p>
                    </div>
                    
                    <div class="data-block">
                        <p class="font-bold text-gray-700">‡∏™‡∏µ‡∏´‡∏•‡∏±‡∏Å/‡∏™‡∏µ‡∏£‡∏≠‡∏á:</p>
                        <p class="text-lg">{{ dog.primary_color|default:"-" }} / {{ dog.secondary_color|default:"-" }}</p>
                    </div>
                    <div class="data-block">
                        <p class="font-bold text-gray-700">‡∏Ç‡∏ô‡∏≤‡∏î:</p>
                        <p class="text-lg">{{ size_display|default:"-" }}</p>
                    </div>
                    <div class="data-block">
                        <p class="font-bold text-gray-700">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å:</p>
                        <p class="text-lg">{% if dog.weight %}{{ dog.weight }} ‡∏Å‡∏Å.{% else %}-{% endif %}</p>
                    </div>
                    
                    <div class="md:col-span-2 data-block">
                        <p class="font-bold text-gray-700">‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞/‡∏£‡∏≠‡∏¢‡∏ï‡∏≥‡∏´‡∏ô‡∏¥‡πÄ‡∏î‡πà‡∏ô:</p>
                        <div class="whitespace-pre-wrap p-3 bg-gray-50 rounded-md border border-gray-200">{{ dog.distinguishing_marks|default:"‡πÑ‡∏°‡πà‡∏°‡∏µ" }}</div>
                    </div>
                    
                    <div class="md:col-span-2 space-y-3">
                        <div class="data-block">
                            <p class="font-bold text-gray-700">‡∏ô‡∏¥‡∏™‡∏±‡∏¢‡∏Ç‡∏≠‡∏á‡∏™‡∏∏‡∏ô‡∏±‡∏Ç:</p>
                            <div class="whitespace-pre-wrap p-3 bg-gray-50 rounded-md border border-gray-200">{{ dog.personality|default:"-" }}</div>
                        </div>
                        <div class="data-block">
                            <p class="font-bold text-gray-700">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÇ‡∏õ‡∏£‡∏î:</p>
                            <div class="whitespace-pre-wrap p-3 bg-gray-50 rounded-md border border-gray-200">{{ dog.favorite_food|default:"-" }}</div>
                        </div>
                        <div class="data-block">
                            <p class="font-bold text-gray-700">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÅ‡∏û‡πâ (Allergies):</p>
                            <div class="whitespace-pre-wrap p-3 bg-gray-50 rounded-md border border-gray-200">{{ dog.allergies|default:"‡πÑ‡∏°‡πà‡∏°‡∏µ" }}</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mt-8 text-right">
                {% if not is_edit_mode %}
                <div class="flex gap-2">
                    <a href="{% url 'dog_detail' dog.id %}?edit=true" class="btn btn-warning text-white">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l4.125-4.125a1.875 1.875 0 112.652 2.652l-4.125 4.125a4.5 4.5 0 01-1.897 1.13L6 18l-2.685-.8a4.5 4.5 0 01-1.13-1.897l4.125-4.125a1.875 1.875 0 112.652-2.652L16.862 4.487z" />
                        </svg>
                        ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    </a>
                    <button onclick="delete_modal.showModal()" class="btn btn-error text-white">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />
                        </svg>
                        ‡∏•‡∏ö‡∏™‡∏∏‡∏ô‡∏±‡∏Ç
                    </button>
                    <a href="{% url 'dog_list' %}" class="btn btn-outline btn-primary">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 15L3 9m0 0l6-6M3 9h18" />
                        </svg>
                        ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏∏‡∏ô‡∏±‡∏Ç
                    </a>
                </div>
                {% endif %}
            </div>
        {% endif %}
    </div>
    
    {# Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö #}
    <dialog id="delete_modal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg text-error">‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏∏‡∏ô‡∏±‡∏Ç</h3>
            <p class="py-4">‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏∏‡∏ô‡∏±‡∏Ç "<strong>{{ dog.name }}</strong>" ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö?</p>
            <p class="text-sm text-gray-500 mb-4">‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ</p>
            <div class="modal-action">
                <form method="post" action="{% url 'delete_dog_page' dog.id %}">
                    {% csrf_token %}
                    <button type="button" onclick="delete_modal.close()" class="btn btn-outline">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="submit" class="btn btn-error text-white">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö</button>
                </form>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>
    
    {% if is_edit_mode %}
    {% block extra_scripts %}
    <script>
    // ‡∏£‡∏≠‡πÉ‡∏´‡πâ Dropzone ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô
    function initDropzoneEdit() {
        if (typeof Dropzone === 'undefined') {
            console.error('Dropzone.js is not loaded');
            setTimeout(initDropzoneEdit, 100);
            return;
        }
        
        // ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô auto-discover ‡∏Ç‡∏≠‡∏á Dropzone
        Dropzone.autoDiscover = false;
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ element ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏£‡∏¥‡∏á
        const dropzoneElement = document.getElementById('dropzone-area');
        if (!dropzoneElement) {
            console.error('Dropzone element not found');
            return;
        }
        
        // ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà
        let uploadedFiles = [];
        const maxFiles = 5;
        let existingImagesCount = {{ dog_images.count|default:0 }};
        
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á Dropzone instance
        const dropzone = new Dropzone("#dropzone-area", {
            url: "#",
            autoProcessQueue: false,
            addRemoveLinks: false,
            maxFiles: maxFiles,
            acceptedFiles: "image/*",
            dictDefaultMessage: "",
            dictMaxFilesExceeded: `‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î ${maxFiles} ‡∏£‡∏π‡∏õ`,
            clickable: true,
            init: function() {
                const dz = this;
                console.log('Dropzone initialized for edit mode');
                
                // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå
                dz.on("addedfile", function(file) {
                    console.log('File added:', file.name);
                    const totalFiles = uploadedFiles.length + existingImagesCount;
                    if (totalFiles >= maxFiles) {
                        dz.removeFile(file);
                        alert(`‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î ${maxFiles} ‡∏£‡∏π‡∏õ`);
                        return;
                    }
                    
                    uploadedFiles.push(file);
                    updateFormset();
                    updatePreview();
                });
                
                // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå
                dz.on("removedfile", function(file) {
                    console.log('File removed:', file.name);
                    uploadedFiles = uploadedFiles.filter(f => f !== file);
                    updateFormset();
                    updatePreview();
                });
                
                // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ error
                dz.on("error", function(file, message) {
                    console.error('Dropzone error:', message);
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + message);
                });
            }
        });
        
        // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏î‡∏¥‡∏°
        document.querySelectorAll('.remove-existing-image').forEach(btn => {
            btn.addEventListener('click', function() {
                const imageItem = this.closest('.existing-image-item');
                const deleteCheckbox = imageItem.querySelector('input[type="checkbox"][name$="-DELETE"]');
                if (deleteCheckbox) {
                    deleteCheckbox.checked = true;
                    imageItem.style.opacity = '0.5';
                    imageItem.style.pointerEvents = 'none';
                    existingImagesCount--;
                }
            });
        });
        
        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï FormSet ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà
        function updateFormset() {
            const formsetContainer = document.getElementById('formset-container');
            const formsetForms = document.getElementById('formset-forms');
            const managementForm = formsetContainer.querySelector('[name$="-TOTAL_FORMS"]');
            
            // ‡∏ô‡∏±‡∏ö‡∏£‡∏π‡∏õ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏•‡∏ö
            const existingNotDeleted = document.querySelectorAll('.existing-image-item input[type="checkbox"][name$="-DELETE"]:not(:checked)').length;
            
            // ‡∏•‡πâ‡∏≤‡∏á formset forms ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà
            formsetForms.innerHTML = '';
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á form ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà
            uploadedFiles.forEach((file, index) => {
                const formIndex = existingNotDeleted + index;
                const formDiv = document.createElement('div');
                formDiv.innerHTML = `
                    <input type="file" name="images-${formIndex}-image" id="id_images-${formIndex}-image" style="display: none;">
                `;
                formsetForms.appendChild(formDiv);
                
                // ‡πÉ‡∏™‡πà‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô input
                const fileInput = formDiv.querySelector('input[type="file"]');
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                fileInput.files = dataTransfer.files;
            });
            
            // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï TOTAL_FORMS
            if (managementForm) {
                managementForm.value = existingNotDeleted + uploadedFiles.length;
            }
        }
        
        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï Preview ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà
        function updatePreview() {
            const previewContainer = document.getElementById('image-preview');
            previewContainer.innerHTML = '';
            
            if (uploadedFiles.length > 0) {
                const title = document.createElement('h3');
                title.className = 'text-md font-semibold text-gray-700 mb-2 col-span-full';
                title.textContent = '‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏´‡∏°‡πà:';
                previewContainer.appendChild(title);
            }
            
            uploadedFiles.forEach((file, index) => {
                const previewDiv = document.createElement('div');
                previewDiv.className = 'relative';
                
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                img.className = 'w-full h-32 object-cover rounded-md border';
                img.alt = `Preview ${index + 1}`;
                
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'absolute top-2 right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center hover:bg-red-600';
                removeBtn.innerHTML = '√ó';
                removeBtn.onclick = function() {
                    dropzone.removeFile(file);
                };
                
                previewDiv.appendChild(img);
                previewDiv.appendChild(removeBtn);
                previewContainer.appendChild(previewDiv);
            });
        }
        
        // ‡πÄ‡∏°‡∏∑‡πà‡∏≠ submit form
        document.getElementById('dog-edit-form').addEventListener('submit', function(e) {
            // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï formset ‡∏Å‡πà‡∏≠‡∏ô submit
            updateFormset();
        });
    }
    
    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠ DOM ‡∏û‡∏£‡πâ‡∏≠‡∏°
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initDropzoneEdit);
    } else {
        initDropzoneEdit();
    }
    </script>
    {% endblock %}
    {% endif %}
{% endblock %}
