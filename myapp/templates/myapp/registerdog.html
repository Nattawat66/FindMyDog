{% extends "base.html" %}

{% block title %}‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏ô‡∏±‡∏Ç{% endblock %} 

{% block extra_head %}
<style>
    /* ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á Dropzone ‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö DaisyUI */
    .dropzone {
        border: 2px dashed #3B82F6;
        border-radius: 0.5rem;
        background: #f9fafb;
        min-height: 200px;
        padding: 2rem;
        cursor: pointer;
        position: relative;
    }
    .dropzone.dz-drag-hover {
        border-color: #2563eb;
        background: #eff6ff;
    }
    .dropzone.dz-clickable {
        cursor: pointer;
    }
    .dropzone.dz-clickable * {
        cursor: pointer;
    }
    .dz-preview {
        margin: 0.5rem;
        display: inline-block;
        position: relative;
    }
    .dz-preview .dz-image {
        border-radius: 0.5rem;
        overflow: hidden;
    }
    .dz-preview .dz-remove {
        position: absolute;
        top: 5px;
        right: 5px;
        background: #ef4444;
        color: white;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 14px;
        z-index: 10;
    }
    .dz-preview .dz-remove:hover {
        background: #dc2626;
    }
    .dz-message {
        text-align: center;
        margin: 2rem 0;
        pointer-events: none;
    }
    .dz-message p {
        margin-bottom: 1rem;
    }
    .dz-message .dz-button {
        background: #3B82F6;
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        border: none;
        cursor: pointer;
        font-weight: 500;
        pointer-events: auto;
    }
    .dz-message .dz-button:hover {
        background: #2563eb;
    }
    /* ‡∏ã‡πà‡∏≠‡∏ô preview ‡∏Ç‡∏≠‡∏á Dropzone ‡πÄ‡∏≠‡∏á ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÉ‡∏ä‡πâ preview ‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤‡πÄ‡∏≠‡∏á */
    .dz-preview {
        display: none !important;
    }
</style>
{% endblock %}

{% block content %}

    <div class="max-w-4xl mx-auto bg-white p-8 shadow-xl rounded-xl">
        <h1 class="text-3xl font-bold text-gray-800 mb-6">üê∂ ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏ô‡∏±‡∏Ç</h1>
        
        {% if messages %}
            <div class="mb-6">
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} mb-2">
                        <span>{{ message }}</span>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
        
        <form method="post" enctype="multipart/form-data" id="dog-form" class="space-y-8">
            {% csrf_token %}

            <div class="bg-base-100 p-6 rounded-lg border border-gray-200">
                <h2 class="text-xl font-semibold text-primary-blue-custom mb-4">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-control">{{ form.name.label_tag }}{{ form.name }}</div>
                    <div class="form-control">{{ form.breed.label_tag }}{{ form.breed }}</div>
                    <div class="form-control">{{ form.age.label_tag }}{{ form.age }}</div>
                    
                    <div class="form-control">
                        <label class="label">{{ form.gender.label }}</label>
                        {{ form.gender }}
                    </div>
                </div>
            </div>

            <div class="bg-base-100 p-6 rounded-lg border border-gray-200">
                <h2 class="text-xl font-semibold text-primary-blue-custom mb-4">‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡∏†‡∏≤‡∏û</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="form-control">{{ form.primary_color.label_tag }}{{ form.primary_color }}</div>
                    <div class="form-control">{{ form.secondary_color.label_tag }}{{ form.secondary_color }}</div>
                    
                    <div class="form-control">
                        <label class="label">{{ form.size.label }}</label>
                        {{ form.size }}
                    </div>

                    <div class="form-control">{{ form.weight.label_tag }}{{ form.weight }}</div>
                    
                    <div class="form-control md:col-span-3">
                        {{ form.distinguishing_marks.label_tag }}
                        {{ form.distinguishing_marks }}
                    </div>
                </div>
            </div>
            
            <div class="bg-base-100 p-6 rounded-lg border border-gray-200">
                <h2 class="text-xl font-semibold text-primary-blue-custom mb-4">‡∏ô‡∏¥‡∏™‡∏±‡∏¢‡πÅ‡∏•‡∏∞‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-control">{{ form.personality.label_tag }}{{ form.personality }}</div>
                    <div class="form-control">{{ form.favorite_food.label_tag }}{{ form.favorite_food }}</div>
                    <div class="form-control">{{ form.allergies.label_tag }}{{ form.allergies }}</div>
                </div>
                <div class="form-control mt-4">
                    <label class="label cursor-pointer justify-start gap-3">
                        {{ form.is_lost }}
                        <span class="label-text text-lg">{{ form.is_lost.label }} (‡∏´‡∏≤‡∏Å‡∏™‡∏∏‡∏ô‡∏±‡∏Ç‡∏´‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß)</span>
                    </label>
                </div>
            </div>

            <div class="bg-base-100 p-6 rounded-lg border border-gray-200">
                <h2 class="text-xl font-semibold text-primary-blue-custom mb-4">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏™‡∏∏‡∏ô‡∏±‡∏Ç (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 5 ‡∏£‡∏π‡∏õ)</h2>
                
                {# Dropzone Area #}
                <div id="dropzone-area" class="dropzone">
                    <div class="dz-message">
                        <p class="text-lg text-gray-600 mb-2">‡∏•‡∏≤‡∏Å‡πÅ‡∏•‡∏∞‡∏ß‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå</p>
                    </div>
                </div>
                
                {# Hidden formset ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û #}
                <div id="formset-container" style="display: none;">
                {{ formset.management_form }}
                    <div id="formset-forms"></div>
                </div>
                
                {# Preview area #}
                <div id="image-preview" class="mt-4 grid grid-cols-2 md:grid-cols-3 gap-4"></div>
            </div>

            <button type="submit" 
                    class="btn btn-lg w-full text-white bg-primary-blue-custom hover:bg-blue-600 border-none">
                ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏ô‡∏±‡∏Ç
            </button>
        </form>
        
    </div>
{% endblock %}

{% block extra_scripts %}
<script>
// ‡∏£‡∏≠‡πÉ‡∏´‡πâ Dropzone ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô
function initDropzone() {
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Dropzone ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
    if (typeof Dropzone === 'undefined') {
        console.log('Waiting for Dropzone.js to load...');
        setTimeout(initDropzone, 100);
        return;
    }
    
    console.log('Dropzone.js loaded, initializing...');
    
    // ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô auto-discover ‡∏Ç‡∏≠‡∏á Dropzone
    Dropzone.autoDiscover = false;
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ element ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏£‡∏¥‡∏á
    const dropzoneElement = document.getElementById('dropzone-area');
    if (!dropzoneElement) {
        console.error('Dropzone element not found');
        return;
    }
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ element ‡∏ô‡∏µ‡πâ‡∏°‡∏µ Dropzone instance ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if (dropzoneElement.dropzone) {
        console.log('Dropzone already initialized, destroying old instance...');
        dropzoneElement.dropzone.destroy();
    }
    
    // ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î
    let uploadedFiles = [];
    const maxFiles = 5;
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Dropzone instance
    let dropzone;
    try {
        dropzone = new Dropzone("#dropzone-area", {
            url: "#", // ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ auto-upload
            autoProcessQueue: false,
            addRemoveLinks: false,
            maxFiles: maxFiles,
            acceptedFiles: "image/*",
            dictDefaultMessage: "",
            dictMaxFilesExceeded: `‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î ${maxFiles} ‡∏£‡∏π‡∏õ`,
            clickable: true, // ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å
            init: function() {
                const dz = this;
                console.log('Dropzone initialized successfully');
                
                // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå
                dz.on("addedfile", function(file) {
                    console.log('File added:', file.name);
                    if (uploadedFiles.length >= maxFiles) {
                        dz.removeFile(file);
                        alert(`‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î ${maxFiles} ‡∏£‡∏π‡∏õ`);
                        return;
                    }
                    
                    uploadedFiles.push(file);
                    updateFormset();
                    updatePreview();
                });
                
                // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå
                dz.on("removedfile", function(file) {
                    console.log('File removed:', file.name);
                    uploadedFiles = uploadedFiles.filter(f => f !== file);
                    updateFormset();
                    updatePreview();
                });
                
                // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ error
                dz.on("error", function(file, message) {
                    console.error('Dropzone error:', message);
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + message);
                });
                
                // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å
                dz.on("click", function() {
                    console.log('Dropzone clicked');
                });
            }
        });
        console.log('Dropzone instance created:', dropzone);
    } catch (error) {
        console.error('Error creating Dropzone:', error);
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á Dropzone: ' + error.message);
        return;
    }
    
    
    // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï FormSet
    function updateFormset() {
        const formsetContainer = document.getElementById('formset-container');
        const formsetForms = document.getElementById('formset-forms');
        const managementForm = formsetContainer.querySelector('[name$="-TOTAL_FORMS"]');
        const initialForm = formsetContainer.querySelector('[name$="-INITIAL_FORMS"]');
        const minNumForm = formsetContainer.querySelector('[name$="-MIN_NUM_FORMS"]');
        const maxNumForm = formsetContainer.querySelector('[name$="-MAX_NUM_FORMS"]');
        
        // ‡∏•‡πâ‡∏≤‡∏á formset forms
        formsetForms.innerHTML = '';
        
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á form ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÑ‡∏ü‡∏•‡πå
        uploadedFiles.forEach((file, index) => {
            const formDiv = document.createElement('div');
            formDiv.innerHTML = `
                <input type="file" name="images-${index}-image" id="id_images-${index}-image" style="display: none;">
            `;
            formsetForms.appendChild(formDiv);
            
            // ‡πÉ‡∏™‡πà‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô input
            const fileInput = formDiv.querySelector('input[type="file"]');
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            fileInput.files = dataTransfer.files;
        });
        
        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï TOTAL_FORMS
        if (managementForm) {
            managementForm.value = uploadedFiles.length;
        }
        
        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï INITIAL_FORMS, MIN_NUM_FORMS, MAX_NUM_FORMS ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
        if (initialForm) initialForm.value = 0;
        if (minNumForm) minNumForm.value = 0;
        if (maxNumForm) maxNumForm.value = maxFiles;
    }
    
    // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï Preview
    function updatePreview() {
        const previewContainer = document.getElementById('image-preview');
        previewContainer.innerHTML = '';
        
        uploadedFiles.forEach((file, index) => {
            const previewDiv = document.createElement('div');
            previewDiv.className = 'relative';
            
            const img = document.createElement('img');
            img.src = URL.createObjectURL(file);
            img.className = 'w-full h-32 object-cover rounded-md border';
            img.alt = `Preview ${index + 1}`;
            
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'absolute top-2 right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center hover:bg-red-600';
            removeBtn.innerHTML = '√ó';
            removeBtn.onclick = function() {
                dropzone.removeFile(file);
            };
            
            previewDiv.appendChild(img);
            previewDiv.appendChild(removeBtn);
            previewContainer.appendChild(previewDiv);
        });
    }
    
    // ‡πÄ‡∏°‡∏∑‡πà‡∏≠ submit form
    const dogForm = document.getElementById('dog-form');
    if (dogForm) {
        dogForm.addEventListener('submit', function(e) {
            // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï formset ‡∏Å‡πà‡∏≠‡∏ô submit
            updateFormset();
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            if (uploadedFiles.length === 0) {
                // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πá‡πÉ‡∏´‡πâ submit ‡πÑ‡∏î‡πâ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)
            }
        });
    }
}

// ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠ DOM ‡∏û‡∏£‡πâ‡∏≠‡∏°
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initDropzone);
} else {
    initDropzone();
}
</script>
{% endblock %}
