{% extends "base.html" %}
{% load static %}

{% block title %}‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏∏‡∏ô‡∏±‡∏Ç‡∏ó‡∏µ‡πà‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡∏Å‡∏±‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'dropzone-custom.css' %}" />

<div class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">
    <header class="text-center mb-8">
        <h1 class="text-3xl font-extrabold text-indigo-600">üîç Image Search</h1>
        <p class="text-gray-600 mt-2">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏™‡∏∏‡∏ô‡∏±‡∏Ç‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡∏Å‡∏±‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤</p>
    </header>

    <div class="card bg-white shadow-xl border border-gray-100 mb-8">
        <div class="card-body">
            <form method="POST" enctype="multipart/form-data" id="matchdog-form" class="w-full">
                {% csrf_token %}
                
                <!-- Hidden Input for Dropzone -->
                <input type="file" name="image" id="id_image" accept="image/*" style="display: none;" />

                <!-- Dropzone Area -->
                <div id="dropzone-area" class="dropzone w-full h-64 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100 transition flex flex-col items-center justify-center">
                     <div class="dz-message text-center">
                        <svg class="w-10 h-10 mb-3 text-gray-400 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                        <p class="mb-2 text-sm text-gray-500"><span class="font-semibold">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î</span> ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡∏°‡∏≤‡∏ß‡∏≤‡∏á</p>
                        <p class="text-xs text-gray-400">PNG, JPG ‡∏´‡∏£‡∏∑‡∏≠ JPEG (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5MB)</p>
                     </div>
                </div>

                <!-- Preview Area -->
                <div id="image-preview" class="mt-4 grid grid-cols-1 justify-items-center"></div>

                <div class="card-actions mt-6 justify-center">
                    <button type="submit" id="btn-search" class="btn btn-primary btn-wide">
                        ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•
                    </button>
                </div>
            </form>
        </div>
    </div>

    {% if is_result %}
    <div id="results-section" class="space-y-4">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">üèÜ ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡∏Ñ‡∏•‡∏∂‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î 5 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</h2>
        <div id="ranking-list" class="grid gap-6">
            {% for dog in search_results %}
            <div class="card card-side bg-base-100 shadow-md hover:shadow-xl transition border border-gray-100">
                <figure class="w-24 sm:w-48 h-full bg-gray-100">
                    {% if dog.images.first %}
                        <img src="{{ dog.images.first.image.url }}" alt="{{ dog.name }}" class="object-cover w-full h-full" />
                    {% else %}
                        <div class="flex items-center justify-center w-full h-full text-gray-400">
                            <span class="text-2xl">üêï</span>
                        </div>
                    {% endif %}
                </figure>
                <div class="card-body p-4 justify-between">
                    <div>
                        <div class="flex justify-between items-start">
                            <h3 class="card-title text-indigo-700">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö {{ forloop.counter }}: {{ dog.name }}</h3>
                            <div class="badge {% if forloop.first %}badge-error{% elif forloop.counter == 2 %}badge-warning{% else %}badge-ghost{% endif %} gap-2 p-3 font-bold">
                                {{ dog.similarity_score }}% ‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢
                            </div>
                        </div>
                        {% comment %} <p class="text-gray-500 text-sm">‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå: {{ dog.breed }}</p> {% endcomment %}
                    </div>
                    <div class="card-actions justify-end">
                        <a href="{% url 'dog_detail' dog.id %}" class="btn btn-sm btn-outline">‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏ô‡∏±‡∏Ç</a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    <script>
        // Scroll to results if present
        document.getElementById('results-section').scrollIntoView({ behavior: 'smooth' });
    </script>
    {% endif %}
</div>
{% endblock %}

{% block extra_scripts %}
<script src="{% static 'dropzone-custom.js' %}?v=2"></script>
<script>
    // Initialize Dropzone
    initDropzoneSingle({
        dropzoneId: "dropzone-area",
        previewContainerId: "image-preview",
        inputId: "id_image",
        formId: "matchdog-form",
        maxFiles: 1,
    });

    // Loading state handling
    document.getElementById('matchdog-form').addEventListener('submit', function() {
        const btn = document.getElementById('btn-search');
        btn.classList.add('loading');
        btn.innerText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...';
    });
</script>
{% endblock %}