
from .forms import DogForm, DogImageFormSet,OrgAdminDogForm,VACCINE_CHOICES,NotificationForm
from django.shortcuts import render, redirect ,get_object_or_404
from django.http import Http404
from django.contrib.auth import authenticate, login as auth_login
from django.contrib import messages
from django.views.decorators.csrf import csrf_protect
from django.contrib.auth.decorators import login_required
from .models import Dog, DogImage, User,Notification, AdoptionParent
from django.db.models import Q
from django.db import models



# ---------- UI Render Views ----------
@login_required
def dog_list(request):
    # ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏∏‡∏ô‡∏±‡∏Ç‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
    # (‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ß‡πà‡∏≤‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ owner = models.ForeignKey(User, ...) ‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß)
    is_admin = request.user.is_staff
    
    is_org = request.user.role == 'org_admin'
    if is_admin:
        # Admin: ‡∏î‡∏∂‡∏á‡∏™‡∏∏‡∏ô‡∏±‡∏Ç‡∏ó‡∏∏‡∏Å‡∏ï‡∏±‡∏ß‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
        # (‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏≤‡∏à‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ .select_related('owner') ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡∏Å‡∏≤‡∏£ Query ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á)
        dogs_queryset = Dog.objects.all().select_related('owner').order_by('-id')
    else:
        # User ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ: ‡∏î‡∏∂‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏∏‡∏ô‡∏±‡∏Ç‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏ô‡∏ô‡∏±‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á
        dogs_queryset = Dog.objects.filter(owner=request.user).order_by('-id')

    context = {
        'dogs': dogs_queryset,
        'has_dogs': dogs_queryset.exists(),
        'is_admin': is_admin,
        'is_org': is_org,   
    }
    # Render template ‡πÄ‡∏î‡∏¥‡∏°
    return render(request, 'myapp/dog/dog_list.html', context)


@login_required
def dog_detail(request, dog_id):
    # Admin (is_staff) ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏π‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡∏ï‡∏±‡∏ß, User ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (is_staff=False) ‡∏î‡∏π‡πÑ‡∏î‡πâ‡πÅ‡∏Ñ‡πà‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á
    is_org = request.user.role == 'org_admin'
    if request.user.is_staff:
        # Admin: ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç owner
        # ‡πÉ‡∏ä‡πâ .get() ‡πÅ‡∏ó‡∏ô .filter() ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏¥‡∏î 404 ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏û‡∏ö ID
        try:
            dog = Dog.objects.get(pk=dog_id)
        except Dog.DoesNotExist:
            raise Http404("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏∏‡∏ô‡∏±‡∏Ç ID ‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö")
        
        # Admin ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏î‡πâ
        can_edit = True
        
    else:
        # User ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ: ‡∏î‡∏π‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡∏ï‡∏±‡∏ß ‡πÅ‡∏ï‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á
        # ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏ô‡∏±‡∏Ç‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ä‡πá‡∏Ñ owner ‡∏Å‡πà‡∏≠‡∏ô (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏î‡∏π‡πÑ‡∏î‡πâ)
        dog = get_object_or_404(Dog, pk=dog_id)
        
        # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
        if dog.owner == request.user:
            # User ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á
            can_edit = True
        else:
            # ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á: ‡∏î‡∏π‡πÑ‡∏î‡πâ‡πÅ‡∏ï‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
            can_edit = False

    # ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Form class ‡∏ï‡∏≤‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
    DogFormClass = OrgAdminDogForm if is_org else DogForm

    # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    is_edit_mode = request.GET.get('edit', 'false').lower() == 'true' and can_edit
    
    if request.method == 'POST':
        # --- ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Edit/Update) ---
        if not can_edit and not request.user.is_staff:
            messages.error(request, '‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏ô‡∏±‡∏Ç‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ')
            return redirect('dog_detail', dog_id=dog.id)
        # ‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á instance=dog ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏°‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
        form = DogFormClass(request.POST, instance=dog)
        # ‚ö†Ô∏è ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö FormSet: ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á request.FILES ‡πÅ‡∏•‡∏∞ instance=dog ‡∏î‡πâ‡∏ß‡∏¢
        formset = DogImageFormSet(request.POST, request.FILES, instance=dog) 

        if form.is_valid() and formset.is_valid():
            # 2. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Dog Model ‡∏´‡∏•‡∏±‡∏Å
            dog = form.save()
            
            # 3. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á (‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏•‡∏ö/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û)
            # formset.save() ‡∏à‡∏∞‡∏•‡∏ö objects ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å mark ‡πÉ‡∏´‡πâ‡∏•‡∏ö ‡πÅ‡∏•‡∏∞ signal ‡∏à‡∏∞‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
            formset.save() 
            
            # 4. ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡∏∞ Redirect ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
            # messages.success(request, f'‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏ô‡∏±‡∏Ç "{dog.name}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!')
            return redirect('dog_detail', dog_id=dog.id) 
        else:
            # ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ error ‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
            is_edit_mode = True
            if not form.is_valid():
                for field, errors in form.errors.items():
                    for error in errors:
                        messages.error(request, f'{field}: {error}')
            if not formset.is_valid():
                for form_error in formset.errors:
                    for field, errors in form_error.items():
                        for error in errors:
                            messages.error(request, f'‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û: {error}')
    else:
        # --- ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•/‡πÄ‡∏õ‡∏¥‡∏î‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (Initial Load) ---
        
        # 5. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏ô‡∏±‡∏Ç‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏ü‡∏≠‡∏£‡πå‡∏°
        form = DogFormClass(instance=dog) 
        
        # 6. ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà FormSet
        formset = DogImageFormSet(instance=dog) 

    # ‡∏î‡∏∂‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏™‡∏∏‡∏ô‡∏±‡∏Ç‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (‡∏ó‡∏±‡πâ‡∏á‡πÉ‡∏ô FormSet ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î)
    dog_images = dog.images.all() 

    VACCINE_MAP = dict(VACCINE_CHOICES)
    
    # 3. üêç Logic ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô
    vaccine_history_raw = dog.vaccination_history
    vaccine_display_list = []

    if vaccine_history_raw:
        # ‡πÅ‡∏¢‡∏Å string ‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏≠‡∏°‡∏°‡∏≤ ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏î‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á
        raw_list = [v.strip() for v in vaccine_history_raw.split(',') if v.strip()]
        
        for key in raw_list:
            # ‡∏î‡∏∂‡∏á‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏à‡∏≤‡∏Å Map (‡∏ñ‡πâ‡∏≤‡∏´‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ key ‡πÄ‡∏î‡∏¥‡∏°)
            display_value = VACCINE_MAP.get(key, key)
            vaccine_display_list.append(display_value)
            
    context = {
        'dog': dog,
        'form': form, # ‡∏™‡πà‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
        'formset': formset, # ‡∏™‡πà‡∏á FormSet ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
        'dog_images': dog_images, 
        'gender_display': dog.get_gender_display(),
        'size_display': dog.get_size_display(),
        'sterilization_display': dog.get_sterilization_status_display(),
        'is_edit_mode': is_edit_mode, # ‡∏™‡πà‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
        'can_edit': can_edit, # ‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
        'vaccine_display_list': vaccine_display_list,
        'is_org': is_org,
    }
    return render(request, 'myapp/dog/dog_detail.html', context)

@login_required # ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô
def register_dog_page(request):
    role = request.user.role
    if role == 'org_admin':
        DogFormClass = OrgAdminDogForm
    else:
        DogFormClass = DogForm
    if request.method == 'POST':
        form = DogFormClass(request.POST)
        formset = DogImageFormSet(request.POST, request.FILES)

        if form.is_valid() and formset.is_valid():
            # 1. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Dog Model ‡∏´‡∏•‡∏±‡∏Å
            dog = form.save(commit=False)
            dog.owner = request.user # ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            # ‡∏´‡∏≤‡∏Å‡∏°‡∏µ Organization Model ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏î‡πâ‡∏ß‡∏¢:
            # dog.organization = some_organization_object 
            dog.save()

            # 2. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á - ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á instance=dog ‡∏Å‡πà‡∏≠‡∏ô
            formset.instance = dog
            formset.save()  # Django FormSet ‡∏à‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ empty forms ‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏á
            
            # 3. ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡∏∞ Redirect
            # messages.success(request, f'‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏∏‡∏ô‡∏±‡∏Ç "{dog.name}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!')
            return redirect('dog_list')
        else:
            # ‡πÅ‡∏™‡∏î‡∏á error messages ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
            if not form.is_valid():
                for field, errors in form.errors.items():
                    for error in errors:
                        messages.error(request, f'{field}: {error}')
            if not formset.is_valid():
                for form_error in formset.errors:
                    for field, errors in form_error.items():
                        for error in errors:
                            messages.error(request, f'‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û: {error}') 
    else:
        form = DogFormClass()
        formset = DogImageFormSet(queryset=DogImage.objects.none()) # ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏õ‡∏•‡πà‡∏≤

    context = {
        'form': form,
        'formset': formset,
        'role' : role,
    }
    return render(request, 'myapp/dog/registerdog.html', context)
@csrf_protect
def register(request):
    if request.method == 'POST':
        username = request.POST.get('username')
        email = request.POST.get('email')
        password = request.POST.get('password')
        password_confirm = request.POST.get('password_confirm')
        
        # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        if password != password_confirm:
            messages.error(request, '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô')
            return render(request, 'myapp/registeruser.html')
        
        # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ username ‡∏´‡∏£‡∏∑‡∏≠ email ‡∏ã‡πâ‡∏≥‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        if User.objects.filter(username=username).exists():
            messages.error(request, '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß')
            return render(request, 'myapp/registeruser.html')
        
        if email and User.objects.filter(email=email).exists():
            messages.error(request, '‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß')
            return render(request, 'myapp/registeruser.html')
        
        # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà
        try:
            user = User.objects.create_user(
                username=username,
                email=email if email else '',
                password=password
            )
            # messages.success(request, '‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö')
            return redirect('login')
        except Exception as e:
            messages.error(request, f'‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: {str(e)}')
            return render(request, 'myapp/registeruser.html')
    
    return render(request, 'myapp/authen/registeruser.html')

# from django.contrib.admin.views.decorators import staff_member_required

# @staff_member_required
# def admin_page(request):
#     return render(request, 'admin_page.html')

@csrf_protect 
def login(request):
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')

        user = authenticate(request, username=username, password=password)
            
        if not username or not password:
            messages.error(request, '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô')
            return render(request, 'myapp/loginuser.html')
        
        if user is not None:
            if user.is_staff:
                return redirect('admin_page')
            if user.is_active == False:
                messages.error(request, '‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏£‡∏∞‡∏á‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô')
                return render(request, 'myapp/loginuser.html')
            auth_login(request, user)
            # messages.success(request, f'‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö {user.username}!')
            # Redirect ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
            # ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ next parameter ‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πâ‡∏ô ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡∏ó‡∏µ‡πà home ‡∏ï‡∏≤‡∏° LOGIN_REDIRECT_URL
            next_url = request.GET.get('next', None)
            if next_url:
                return redirect(next_url)
            else:
                return redirect('home')  # ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠ URL pattern ‡πÅ‡∏ó‡∏ô path
        else:
            messages.error(request, '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á')
            return redirect('login')
        

    return render(request, 'myapp/authen/loginuser.html')

# @login_required
# def admin_page(request):
#     if not request.user.is_staff:
#         messages.error(request, '‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ')
#         return redirect('home')
#     return render(request, 'admin/index.html')
def admin_page(request):
    return render(request, 'admin/dashdoardAI/dashdoard.html')

def set_auto_training(request):
    return render(request, 'admin/Training/SetautoTraining.html')

def my_login_view(request)  :
    if request.method == 'POST':
        username = request.POST.get('username')
        password = request.POST.get('password')
        # Authenticate the user
        user = authenticate(request, username=username, password=password)
        if user is not None:
            # Log the user in
            login(request, user)
            # Redirect to a success page or the desired page after login
            return redirect('home')  # Replace 'home' with your desired URL name
        else:
            # Handle invalid login credentials
            # You might want to display an error message to the user
            return render(request, 'login.html', {'error_message': 'Invalid credentials'})
    else:
        # Render the login form for GET requests
        return render(request, 'login.html')

@login_required
def dog_all_list(request):
    context = {
        'total_dogs': Dog.objects.all().count(),
        'lost_dogs': Dog.objects.filter(is_lost=True).count(),
        'org_dogs': Dog.objects.filter(organization=True).count(),
        # 'vaccinated_dogs': Dog.objects.filter(vaccinated=True).count(),
        'dog_list': Dog.objects.all(), # ‡πÉ‡∏ä‡πâ QuerySet ‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô production
    }
    return render(request, 'myapp/dog/dog_all_list.html',context)
    
@login_required
def home(request):
    role = request.user.role
    if request.user.is_staff:
        return render(request, 'myapp/admin_backend/admin_home.html')
    elif role == 'org_admin':
        context = {
            'dogs_org': Dog.objects.filter(organization=True),
            'dogs_org_count': Dog.objects.filter(organization=True).count(),
            'dogs_lost_count': Dog.objects.filter(is_lost=True).count(),
        }
        return render(request, 'myapp/admin_org/admin_org_home.html',context)
    else:
        return render(request, 'myapp/home.html')


@login_required
def delete_dog_page(request, dog_id):
    """
    View ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏ö‡∏™‡∏∏‡∏ô‡∏±‡∏Ç (UI version)
    """
    # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå: ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏∏‡∏ô‡∏±‡∏Ç‡∏î‡πâ‡∏ß‡∏¢ ID ‡πÅ‡∏•‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
    dog = get_object_or_404(
        Dog, 
        pk=dog_id, 
        owner=request.user
    )
    
    if request.method == 'POST':
        # ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö
        dog_name = dog.name
        dog.delete()
        # messages.success(request, f'‡∏•‡∏ö‡∏™‡∏∏‡∏ô‡∏±‡∏Ç "{dog_name}" ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!')
        return redirect('dog_list')
    
    # ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô GET request ‡πÉ‡∏´‡πâ redirect ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ detail (modal ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ detail)
    return redirect('dog_detail', dog_id=dog_id)


@login_required
def notification_list_view(request):
    user = request.user
    
    # 1. ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ ‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£)
    # 2. ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏∏‡∏ô‡∏±‡∏Ç‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏û‡πà‡∏≠‡πÅ‡∏°‡πà‡∏ö‡∏∏‡∏ç‡∏ò‡∏£‡∏£‡∏°
    adopted_dogs_pks = AdoptionParent.objects.filter(user=user).values_list('dog__pk', flat=True)
    if user.role == 'org_admin':
        org_dog_pks = Dog.objects.filter(organization=True).values_list('pk', flat=True)
    else:
        org_dog_pks = []
    # 3. ‡∏£‡∏ß‡∏° QuerySets
    notifications = Notification.objects.filter(
        # ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç 1: ACTIVITY ‡∏´‡∏£‡∏∑‡∏≠ LOST_DOG (‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ)
        models.Q(notification_type__in=['ACTIVITY', 'LOST_DOG']) |

        # ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç 2: DOG_SPECIFIC ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏™‡∏∏‡∏ô‡∏±‡∏Ç‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏≠‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏∞
        (models.Q(notification_type='DOG_SPECIFIC') & models.Q(dog__pk__in=adopted_dogs_pks)) |

        # ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç 3: DOG_SPECIFIC ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏™‡∏∏‡∏ô‡∏±‡∏Ç‡πÉ‡∏ô‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
        (models.Q(notification_type='DOG_SPECIFIC') & models.Q(dog__pk__in=org_dog_pks))
    ).order_by('-created_at')

    # üí° [‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Admin] ‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏∏‡∏ô‡∏±‡∏Ç ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Admin ‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£
        # ‡πÉ‡∏´‡πâ‡∏ô‡∏≥‡πÑ‡∏õ‡∏Å‡∏£‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏™‡∏∏‡∏ô‡∏±‡∏Ç‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏π‡πÅ‡∏•‡∏Ç‡∏≠‡∏á Admin ‡∏Ñ‡∏ô‡∏ô‡∏±‡πâ‡∏ô (org_dog_pks)
    
    # ... (‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß/‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏≠‡πà‡∏≤‡∏ô‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ...
    
    context = {
        'notifications': notifications,
        'total_count': notifications.count(),
        # 'unread_count': notifications.filter(is_read=False).count(),
    }
    
    return render(request, 'myapp/notifications/notification_list.html', context)


@login_required
def notification_detail_hx_view(request, notification_id):
    # üí° ‡πÉ‡∏ä‡πâ get_object_or_404 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏ö
    notification = get_object_or_404(Notification, pk=notification_id)

    # üí° [‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå]: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏•‡∏ö
    can_edit = False
    can_delete = False
    
    # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÇ‡∏û‡∏™‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (organization = request.user)
    if notification.organization == request.user:
        can_edit = True
        can_delete = True
    # ‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô super_admin ‡∏Å‡πá‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏•‡∏ö‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    elif request.user.is_staff:
        can_edit = True
        can_delete = True
    
    context = {
        'notification': notification,
        'can_edit': can_edit,
        'can_delete': can_delete,
    }
    # üí° ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå template ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡πà‡∏ß‡∏ô Pop-up
    return render(request, 'myapp/notifications/notification_modal.html', context)


@login_required
def create_notification_view(request):
    # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå: ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Org Admin ‡∏´‡∏£‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®
    if request.user.role not in ['org_admin', 'super_admin']: 
        messages.error(request, "‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£")
        return redirect('home') # ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°

    if request.method == 'POST':
        # üí° ‡∏™‡πà‡∏á request.user ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á (‡πÉ‡∏ô __init__)
        form = NotificationForm(request.POST, request.FILES, user=request.user)
        if form.is_valid():
            notification = form.save(commit=False)
            
            # üí° ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Organization ‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®
            # ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ß‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ Admin ‡∏°‡∏µ‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡∏Å‡∏±‡∏ö Organization
            if request.user.role == 'org_admin':
                # ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏´‡πâ‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Ñ‡∏∑‡∏≠ User Org Admin ‡∏Ñ‡∏ô‡∏ô‡∏±‡πâ‡∏ô
                notification.organization = request.user 
            
            # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó DOG_SPECIFIC ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Dog ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô Invalid
            if notification.notification_type == 'DOG_SPECIFIC' and not notification.dog:
                messages.error(request, "‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏∏‡∏ô‡∏±‡∏Ç ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏∏‡∏ô‡∏±‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á")
                return render(request, 'myapp/notifications/notification_form.html', {'form': form})
            
            notification.save()
            # messages.success(request, f"‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® '{notification.title}' ‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!")
            return redirect('notification_list') # Redirect ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£
    else:
        # üí° ‡∏™‡πà‡∏á request.user ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°
        form = NotificationForm(user=request.user)

    context = {
        'form': form,
        'is_edit_mode': False,
        'title': "‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà",
        'submit_text': "‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®",
    }
    return render(request, 'myapp/notifications/notification_form.html', context)


@login_required
def edit_notification_view(request, notification_id):
    # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå: ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÇ‡∏û‡∏™‡∏´‡∏£‡∏∑‡∏≠ super_admin
    notification = get_object_or_404(Notification, pk=notification_id)
    
    # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
    if notification.organization != request.user and not request.user.is_staff:
        messages.error(request, "‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ô‡∏µ‡πâ")
        return redirect('notification_list')
    
    if request.method == 'POST':
        form = NotificationForm(request.POST, request.FILES, instance=notification, user=request.user)
        if form.is_valid():
            notification = form.save(commit=False)
            
            # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó DOG_SPECIFIC ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Dog ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô Invalid
            if notification.notification_type == 'DOG_SPECIFIC' and not notification.dog:
                messages.error(request, "‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏∏‡∏ô‡∏±‡∏Ç ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏∏‡∏ô‡∏±‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á")
                context = {
                    'form': form,
                    'is_edit_mode': True,
                    'title': "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£",
                    'submit_text': "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç",
                }
                return render(request, 'myapp/notifications/notification_form.html', context)
            
            notification.save()
            # messages.success(request, f"‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® '{notification.title}' ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!")
            return redirect('notification_list')
    else:
        form = NotificationForm(instance=notification, user=request.user)
    
    context = {
        'form': form,
        'is_edit_mode': True,
        'title': "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£",
        'submit_text': "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç",
    }
    return render(request, 'myapp/notifications/notification_form.html', context)


@login_required
def delete_notification_view(request, notification_id):
    # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå: ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÇ‡∏û‡∏™‡∏´‡∏£‡∏∑‡∏≠ super_admin
    notification = get_object_or_404(Notification, pk=notification_id)
    
    # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
    if notification.organization != request.user and not request.user.is_staff:
        messages.error(request, "‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ô‡∏µ‡πâ")
        return redirect('notification_list')
    
    if request.method == 'POST':
        notification_title = notification.title
        notification.delete()
        # messages.success(request, f"‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® '{notification_title}' ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!")
        return redirect('notification_list')
    
    # ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô GET request ‡πÉ‡∏´‡πâ redirect ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ list
    return redirect('notification_list')
